<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>https://helloxxb.github.io/</id>
    <title>Peter's Blog Blog</title>
    <updated>2022-02-13T20:00:00.000Z</updated>
    <generator>https://github.com/jpmonette/feed</generator>
    <link rel="alternate" href="https://helloxxb.github.io/"/>
    <subtitle>Peter's Blog Blog</subtitle>
    <icon>https://helloxxb.github.io/img/favicons/favicon.ico</icon>
    <entry>
        <title type="html"><![CDATA[利用WebHooks实现代码自动拉取]]></title>
        <id>/2022/02/13/git-hooks-auto-pull</id>
        <link href="https://helloxxb.github.io/2022/02/13/git-hooks-auto-pull"/>
        <updated>2022-02-13T20:00:00.000Z</updated>
        <summary type="html"><![CDATA[其原理是利用 GitLab/GitHub/YourRepository 提供的 WebHooks 钩子事件，创建一个钩子并且监听开发者的 push事件，接收到push事件后会通过POST请求将事件信息推送到指定的URL。当自行搭建的Nginx服务器接收到这个请求后，转发到自己写的 PHP脚本，PHP脚本会做一些基础校验（例如：访问令牌、密码），然后执行提前写好的 Shell 脚本来拉取代码。]]></summary>
        <content type="html"><![CDATA[<p>其原理是利用 <code>GitLab/GitHub/YourRepository</code> 提供的 <code>WebHooks 钩子事件</code>，创建一个钩子并且监听开发者的 <code>push事件</code>，接收到push事件后会通过POST请求将事件信息推送到指定的URL。当自行搭建的Nginx服务器接收到这个请求后，转发到自己写的 <code>PHP脚本</code>，PHP脚本会做一些基础校验（例如：访问令牌、密码），然后执行提前写好的 <code>Shell </code>脚本来拉取代码。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="准备工作">准备工作<a class="hash-link" href="#准备工作" title="标题的直接链接">​</a></h3><blockquote><p>需要 <code>Nginx + PHP 7.* + Swoole 扩展</code> 的环境支持
{: .prompt-info }</p></blockquote><h4 class="anchor anchorWithStickyNavbar_mojV" id="添加钩子说明">添加钩子说明：<a class="hash-link" href="#添加钩子说明" title="标题的直接链接">​</a></h4><p>需要填写【URL（key 用于区分项目）、Secret Token、Trigger】</p><p><strong>URL填写：</strong>
<code>http://test.local.com/gitlab_webhooks?key=c40d160c2ffa013b</code>
<strong>Secret Token填写：</strong>1234567890
<strong>Trigger填写：</strong>仅勾选 Push events 即可</p><div class="codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-text codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain">假设项目目录为：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/home/wwwroot/test.local.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/home/shells/git_pull.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Nginx配置文件：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/usr/local/nginx/conf/vhosts/test.local.com.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">访问项目网址为：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">http://test.local.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">也可直接省略 Nginx 服务，直接采用 Swolle 监听 HTTP服务。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">案例因为使用的是 Docker 容器，项目在容器内。并且只开放了80端口，所以需要 Nginx 做一次转发工作。</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="1-修改配置文件增加代理转发">1. 修改配置文件，增加代理转发<a class="hash-link" href="#1-修改配置文件增加代理转发" title="标题的直接链接">​</a></h3><p><code>以下几步操作都需要进入到 linux 服务器里面进行操作</code></p><div class="language-nginx codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-nginx codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain">vim /usr/local/nginx/conf/vhosts/test.local.com.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># swoole 方式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">## GitLab Webhooks 处理推送事件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">location ^~ /gitlab_webhooks {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ## 此处使用了 ^~ 匹配，所以符合这个条件的，将不再匹配下面的 localtion 段</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ## 转发到本机 6200 端口的 Swoole 程序处理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  proxy_pass http://127.0.0.1:6200;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">## 在这个指令上面增加 代理转发</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">location / {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-----</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># php-fpm 方式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">location ^~ /gitlab_webhooks {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    root /home/wwwroot/gitlab_webhooks;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fastcgi_pass  unix:/tmp/php-cgi.sock;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fastcgi_index index.php;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    include       fastcgi_params;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">## 在这个指令上面增加 代理转发</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">location / {}</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="2-上传处理钩子的代码">2. 上传处理钩子的代码<a class="hash-link" href="#2-上传处理钩子的代码" title="标题的直接链接">​</a></h3><p> <strong>主要的程序文件</strong></p><ul><li><a href="https://gist.github.com/helloxxb/9f6cee5abf0fa98801787b4f28e47a40" target="_blank" rel="noopener noreferrer">WebhooksInterface.php</a></li><li><a href="https://gist.github.com/helloxxb/6270295e556ef98cd01a4942cde07f9b" target="_blank" rel="noopener noreferrer">GitPull.php</a></li><li><a href="https://gist.github.com/helloxxb/91b2750df0f1d43aac56e4d36acdbf04" target="_blank" rel="noopener noreferrer">WebhooksHttpServer.php</a></li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="3-启动-swoole-程序">3. 启动 Swoole 程序<a class="hash-link" href="#3-启动-swoole-程序" title="标题的直接链接">​</a></h3><div class="language-bash codeBlockContainer_MPoW theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-bash codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#393A34"><span class="token plain">php /home/wwwroot/gitlab_webhooks/WebhooksHttpServer.php</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">此程序监听的是 </span><span class="token number" style="color:#36acaa">127.0</span><span class="token plain">.0.1:6200</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>]]></content>
        <category label="vcs" term="vcs"/>
        <category label="git-hooks" term="git-hooks"/>
    </entry>
</feed>